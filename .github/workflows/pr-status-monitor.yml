name: PR Status Monitor

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  pull-requests: read
  contents: read

jobs:
  monitor-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Check Open PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üìä Open Pull Requests Status Report"
          echo "===================================="
          echo ""
          
          # Get all open PRs
          PRS=$(gh pr list --repo ${{ github.repository }} --state open --json number,title,author,isDraft,mergeable,mergeStateStatus,reviewDecision,statusCheckRollup --limit 100)
          
          TOTAL_PRS=$(echo "$PRS" | jq '. | length')
          
          if [ "$TOTAL_PRS" -eq 0 ]; then
            echo "‚úÖ No open PRs"
            exit 0
          fi
          
          echo "Total open PRs: $TOTAL_PRS"
          echo ""
          
          # Categorize PRs
          READY_TO_MERGE=0
          NEEDS_REVIEW=0
          HAS_CONFLICTS=0
          CHECKS_PENDING=0
          CHECKS_FAILING=0
          DRAFT_PRS=0
          
          echo "$PRS" | jq -c '.[]' | while read -r pr; do
            NUMBER=$(echo "$pr" | jq -r '.number')
            TITLE=$(echo "$pr" | jq -r '.title')
            AUTHOR=$(echo "$pr" | jq -r '.author.login')
            IS_DRAFT=$(echo "$pr" | jq -r '.isDraft')
            MERGEABLE=$(echo "$pr" | jq -r '.mergeable')
            MERGE_STATE=$(echo "$pr" | jq -r '.mergeStateStatus')
            REVIEW_DECISION=$(echo "$pr" | jq -r '.reviewDecision // "NONE"')
            
            # Count status checks
            TOTAL_CHECKS=$(echo "$pr" | jq '.statusCheckRollup | length')
            PENDING_CHECKS=$(echo "$pr" | jq '[.statusCheckRollup[] | select(.status == "PENDING" or .status == "IN_PROGRESS")] | length')
            FAILED_CHECKS=$(echo "$pr" | jq '[.statusCheckRollup[] | select(.conclusion == "FAILURE" or .conclusion == "TIMED_OUT" or .conclusion == "CANCELLED")] | length')
            
            echo "---"
            echo "PR #$NUMBER: $TITLE"
            echo "  Author: $AUTHOR"
            echo "  Draft: $IS_DRAFT"
            echo "  Mergeable: $MERGEABLE"
            echo "  Merge State: $MERGE_STATE"
            echo "  Review Decision: $REVIEW_DECISION"
            echo "  Checks: $TOTAL_CHECKS total, $PENDING_CHECKS pending, $FAILED_CHECKS failed"
            
            # Categorize
            if [ "$IS_DRAFT" = "true" ]; then
              DRAFT_PRS=$((DRAFT_PRS + 1))
              echo "  Status: üìù DRAFT"
            elif [ "$MERGEABLE" = "CONFLICTING" ]; then
              HAS_CONFLICTS=$((HAS_CONFLICTS + 1))
              echo "  Status: ‚ö†Ô∏è HAS CONFLICTS"
            elif [ "$FAILED_CHECKS" -gt 0 ]; then
              CHECKS_FAILING=$((CHECKS_FAILING + 1))
              echo "  Status: ‚ùå CHECKS FAILING"
            elif [ "$PENDING_CHECKS" -gt 0 ]; then
              CHECKS_PENDING=$((CHECKS_PENDING + 1))
              echo "  Status: ‚è≥ CHECKS PENDING"
            elif [ "$MERGE_STATE" = "BLOCKED" ]; then
              NEEDS_REVIEW=$((NEEDS_REVIEW + 1))
              echo "  Status: üîí BLOCKED (may need review or approval)"
            elif [ "$MERGEABLE" = "MERGEABLE" ] && [ "$MERGE_STATE" = "CLEAN" ]; then
              READY_TO_MERGE=$((READY_TO_MERGE + 1))
              echo "  Status: ‚úÖ READY TO MERGE"
            else
              echo "  Status: ‚ùì UNKNOWN STATE"
            fi
            echo ""
          done
          
          echo "===================================="
          echo "Summary:"
          echo "  ‚úÖ Ready to merge: $READY_TO_MERGE"
          echo "  üîí Needs review: $NEEDS_REVIEW"
          echo "  ‚è≥ Checks pending: $CHECKS_PENDING"
          echo "  ‚ùå Checks failing: $CHECKS_FAILING"
          echo "  ‚ö†Ô∏è Has conflicts: $HAS_CONFLICTS"
          echo "  üìù Draft PRs: $DRAFT_PRS"
          echo "===================================="
          
          # If there are PRs ready to merge, suggest action
          if [ "$READY_TO_MERGE" -gt 0 ]; then
            echo ""
            echo "üí° Suggestion: $READY_TO_MERGE PR(s) are ready to merge!"
            echo "   Consider enabling auto-merge or merging them manually."
          fi
          
          # If there are blocked PRs, explain why
          if [ "$NEEDS_REVIEW" -gt 0 ]; then
            echo ""
            echo "‚ÑπÔ∏è Note: $NEEDS_REVIEW PR(s) are blocked."
            echo "   This could be due to:"
            echo "   - Branch protection rules requiring review"
            echo "   - Required status checks not passing"
            echo "   - Waiting for review approval"
          fi
