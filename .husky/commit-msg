#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Conventional Commits validation hook
# Enforces lowercase prefixes: feat:, fix:, docs:, test:, chore:, refactor:, style:, perf:, ci:, build:, merge:, security:, revert:

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Skip merge commits generated by git (they start with "Merge" by default, but we allow "merge:")
if echo "$commit_msg" | grep -qE "^Merge "; then
  # Auto-convert "Merge " to "merge: " for consistency
  sed -i.bak 's/^Merge /merge: /' "$commit_msg_file"
  echo "✅ Auto-converted 'Merge ' to 'merge: ' for conventional commits"
  exit 0
fi

# Validate conventional commit format
pattern="^(feat|fix|docs|test|chore|refactor|style|perf|ci|build|merge|security|revert)(\(.+\))?: .+"

if ! echo "$commit_msg" | head -1 | grep -qE "$pattern"; then
  echo "❌ Commit message does not follow conventional commits format!"
  echo ""
  echo "Expected format: <type>: <description>"
  echo "                 <type>(<scope>): <description>"
  echo ""
  echo "Valid types (lowercase only):"
  echo "  feat:     - New feature"
  echo "  fix:      - Bug fix"
  echo "  docs:     - Documentation only"
  echo "  test:     - Adding/updating tests"
  echo "  chore:    - Maintenance tasks"
  echo "  refactor: - Code refactoring"
  echo "  style:    - Formatting, whitespace"
  echo "  perf:     - Performance improvement"
  echo "  ci:       - CI/CD changes"
  echo "  build:    - Build system changes"
  echo "  merge:    - Merge commits"
  echo "  security: - Security fixes"
  echo "  revert:   - Revert previous commit"
  echo ""
  echo "Examples:"
  echo "  feat: Add user authentication"
  echo "  fix(api): Resolve timeout issue"
  echo "  docs: Update README with examples"
  echo ""
  echo "Your message was: $commit_msg"
  exit 1
fi

# Check for uppercase type prefix (common mistake)
if echo "$commit_msg" | head -1 | grep -qE "^(Feat|Fix|Docs|Test|Chore|Refactor|Style|Perf|Ci|Build|Merge|Security|Revert):"; then
  echo "❌ Commit type must be lowercase!"
  echo "   Use 'feat:' not 'Feat:'"
  echo ""
  echo "Your message was: $commit_msg"
  exit 1
fi

echo "✅ Commit message follows conventional commits format"
